#!/usr/bin/env python3

from pathlib import Path
import shutil
from python_files.repository_path import WORKFLOWS_DIRECTORY
try:
  from workflow import Workflow
except:
  raise ImportError("Could you exec `pip3 install git+https://github.com/YOCKOW/PythonGitHubActionsWorkflowRepresentation.git`?")
from python_files.workflow_templates import workflow_for_branch, workflow_for_direct_test, workflow_for_checking_commits

official_branches = [
  'master',
  '1.1/development',
  '1.0.x/master',
  '1.0.x/development',
  '1.0.x/experiment'
]

header = """\
# DO NOT MODIFY: This is autogenerated.
# You can edit ".scripts/update-workflows"

"""

def write_workflow_to_file(workflow: Workflow, path: Path):
  print(f"  - Writing {path}")
  with open(path, 'w') as file:
    file.write(header)
    file.write(str(workflow.yaml()))

print("Creating backup files.")
for wf_file in WORKFLOWS_DIRECTORY.iterdir():
  backup = wf_file.with_name(wf_file.name.replace('.yml', '~.yml'))
  shutil.move(wf_file, backup)

print("Generating workflows for each branch.")
for branch in official_branches:
  path = WORKFLOWS_DIRECTORY.joinpath('branch-' + branch.replace('/', '-') + '.yml')
  workflow = workflow_for_branch(branch)
  write_workflow_to_file(workflow, path)

print("Generating \"Direct Test\" workflow.")
write_workflow_to_file(workflow_for_direct_test(excluding_branches=official_branches), WORKFLOWS_DIRECTORY.joinpath('direct-test.yml'))

print("Generating workflow to check commits.")
write_workflow_to_file(workflow_for_checking_commits(), WORKFLOWS_DIRECTORY.joinpath('check-commits.yml'))

print("Removing backup files.")
for wf_file in WORKFLOWS_DIRECTORY.iterdir():
  if wf_file.name.endswith('~.yml'): wf_file.unlink()
