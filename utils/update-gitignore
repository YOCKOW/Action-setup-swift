#!/usr/bin/env python3

from python_files import dependencies, repository_path
import subprocess
import sys
from typing import List

ignorables: List[str] = [
  '.DS_Store',
  '__pycache__',
  '*.pyc',
  '/node_modules/*',
]

prod_deps = sorted(list(dependencies.for_production()))

"""
Write ignorables
"""
gitignore_path_string = str(repository_path.REPOSITORY_ROOT.joinpath('.gitignore'))
print(f'Updating {gitignore_path_string}')

for dep in prod_deps:
  ignorables.append(f'!/node_modules/{dep}')

with open(gitignore_path_string, 'w') as gitignore:
  print((
    "# DO NOT MODIFY: This is autogenerated.\n"
    "# You can edit \"utils/update-gitignore\"\n"
    "\n"
  ), file=gitignore)
  gitignore.write("\n".join(ignorables))
  gitignore.write("\n")

"""
Add git paths of required modules.
"""
print('Add required node packages.')
for dep in prod_deps:
  if dependencies.package_is_installed(dep) and not dependencies.package_is_tracked(dep):
    completed = subprocess.run(['git', 'add', '--force', f'node_modules/{dep}'], cwd=repository_path.REPOSITORY_ROOT, stdout=subprocess.DEVNULL, stderr=sys.stderr)
    if completed.returncode != 0:
      print(f'❌ Failed to add the path to index: {dep}', file=sys.stderr)
      sys.exit(completed.returncode)
    print(f'✅ Added the path to index: {dep}')


"""
Remove git paths from index.
"""
print('Untracking unnecessary node packages.')
for dev_dep in dependencies.for_development_only():
  if dependencies.package_is_installed(dev_dep) and dependencies.package_is_tracked(dev_dep):
    completed = subprocess.run(['git', 'rm', '--cached', '-r', f'node_modules/{dev_dep}'], cwd=repository_path.REPOSITORY_ROOT, stdout=subprocess.DEVNULL, stderr=sys.stderr)
    if completed.returncode != 0:
      print(f'❌ Failed to remove the path from index: {dev_dep}', file=sys.stderr)
      sys.exit(completed.returncode)
    print(f'✅ Removed the path from index: {dev_dep}')


"""
Note
"""
print("NOTE: You can commit changes if necessary.")
